name: Verify Academic Contributor

on:
  pull_request:
    types: [opened, reopened, ready_for_review]

permissions:
  pull-requests: write
  issues: write

jobs:
  verify-contributor:
    runs-on: ubuntu-latest
    name: Verify Academic Status
    
    steps:
      - name: Check if user is verified
        id: check-verified
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            // Get PR author
            const author = context.payload.pull_request.user.login;
            console.log(`Checking verification status for: ${author}`);
            
            // Check if academic-contributors.json exists
            let verifiedContributors = [];
            try {
              const { data } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.github/academic-contributors.json',
                ref: context.payload.pull_request.base.ref
              });
              
              const content = Buffer.from(data.content, 'base64').toString();
              verifiedContributors = JSON.parse(content);
              console.log(`Found ${verifiedContributors.length} verified contributors`);
            } catch (error) {
              console.log('No academic-contributors.json found, will create template');
            }
            
            // Check if author is verified
            const contributor = verifiedContributors.find(c => c.github_username === author);
            
            if (contributor) {
              console.log(`‚úÖ ${author} is a verified academic contributor`);
              console.log(`Institution: ${contributor.institution}`);
              console.log(`Role: ${contributor.role}`);
              return { verified: true, contributor };
            } else {
              console.log(`‚ùå ${author} is not yet verified`);
              return { verified: false, author };
            }
      
      - name: Add verification required label
        if: steps.check-verified.outputs.result && !fromJSON(steps.check-verified.outputs.result).verified
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['verification-required', 'on-hold']
            });
      
      - name: Add verified label
        if: steps.check-verified.outputs.result && fromJSON(steps.check-verified.outputs.result).verified
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: ['verified-academic']
            });
      
      - name: Comment verification required
        if: steps.check-verified.outputs.result && !fromJSON(steps.check-verified.outputs.result).verified
        uses: actions/github-script@v7
        with:
          script: |
            const author = context.payload.pull_request.user.login;
            
            const comment = `## üéì Academic Verification Required
            
            Thank you for your contribution, @${author}! 
            
            This repository requires academic verification for all contributors to ensure scientific rigor and credibility.
            
            ### üìã Verification Process
            
            To get verified as an academic contributor, please:
            
            1. **Email the maintainers** at: \`botanical-research@example.com\` with:
               - Your full name
               - Institution/University affiliation
               - Role (Professor, Researcher, PhD Student, etc.)
               - ORCID iD (if available)
               - Link to institutional profile or Google Scholar
               - Brief description of your research area
            
            2. **Alternative**: Add a comment below with:
               - Your institutional email address (@university.edu, @research-institute.org, etc.)
               - Link to your institutional profile page
               - Your research interests relevant to botanical science
            
            3. **For students**: Your advisor can vouch for you by:
               - Commenting on this PR with their institutional email
               - Confirming your academic standing
            
            ### ‚úÖ Verification Criteria
            
            We verify contributors who are:
            - ‚úÖ Faculty members at accredited universities
            - ‚úÖ Researchers at recognized research institutions
            - ‚úÖ Graduate students (Masters/PhD) in relevant fields
            - ‚úÖ Postdoctoral researchers
            - ‚úÖ Scientists at botanical gardens, museums, or conservation organizations
            
            ### ‚è±Ô∏è Timeline
            
            - Verification typically takes 1-3 business days
            - Once verified, your name will be added to \`.github/academic-contributors.json\`
            - All future PRs will be automatically approved
            
            ### ü§î Questions?
            
            - See [ACADEMIC_VERIFICATION.md](.github/ACADEMIC_VERIFICATION.md) for detailed information
            - Have questions? Comment below or email us
            
            ### üîí Why We Require This
            
            This repository contains scientific notebooks that may be used for:
            - Research and publication
            - Educational purposes
            - Conservation decisions
            - Agricultural planning
            
            We need to ensure all contributions meet academic standards and come from qualified individuals.
            
            ---
            
            **This PR is currently on hold pending verification. We'll review it as soon as you're verified!** üî¨
            
            *Verification workflow run: ${{ github.run_id }}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
      
      - name: Comment verification success
        if: steps.check-verified.outputs.result && fromJSON(steps.check-verified.outputs.result).verified
        uses: actions/github-script@v7
        with:
          script: |
            const result = JSON.parse(process.env.VERIFICATION_RESULT);
            const contributor = result.contributor;
            
            const comment = `## ‚úÖ Academic Verification Confirmed
            
            Thank you @${contributor.github_username}! You are a verified academic contributor.
            
            **Institution:** ${contributor.institution}  
            **Role:** ${contributor.role}  
            ${contributor.orcid ? `**ORCID:** https://orcid.org/${contributor.orcid}` : ''}
            
            Your contribution will now proceed through our standard review process. üéì
            
            ---
            *Verified on: ${contributor.verified_date}*`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
        env:
          VERIFICATION_RESULT: ${{ steps.check-verified.outputs.result }}
