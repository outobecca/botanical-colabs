name: Auto-Generate Documentation

on:
  pull_request:
    types: [opened, synchronize, reopened]
    paths:
      - 'notebooks/**/*.ipynb'
      - '**/*.ipynb'

permissions:
  contents: write
  pull-requests: write

jobs:
  generate-docs:
    runs-on: ubuntu-latest
    name: Generate Wiki Pages and Previews
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: ${{ github.event.pull_request.head.ref }}
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install jupyter nbconvert nbformat pillow
      
      - name: Detect changed notebooks
        id: changed-notebooks
        run: |
          # Get list of changed .ipynb files
          git diff --name-only origin/${{ github.event.pull_request.base.ref }}..HEAD | grep '\.ipynb$' | grep -v '.ipynb_checkpoints' > changed_notebooks.txt || echo "No notebooks changed"
          
          if [ -s changed_notebooks.txt ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            echo "Changed notebooks:"
            cat changed_notebooks.txt
          else
            echo "changed=false" >> $GITHUB_OUTPUT
            echo "No notebook changes detected"
          fi
      
      - name: Generate wiki pages and previews
        if: steps.changed-notebooks.outputs.changed == 'true'
        run: |
          python .github/scripts/generate_documentation.py
        env:
          CHANGED_NOTEBOOKS_FILE: changed_notebooks.txt
      
      - name: Commit generated documentation
        if: steps.changed-notebooks.outputs.changed == 'true'
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # Add generated files
          git add wiki/ previews/ thumbnails/ 2>/dev/null || true
          
          # Check if there are changes to commit
          if git diff --staged --quiet; then
            echo "No documentation changes to commit"
          else
            NOTEBOOK_COUNT=$(wc -l < changed_notebooks.txt)
            git commit -m "docs: auto-generate wiki pages and previews for notebooks" \
                       -m "Generated by GitHub Actions" \
                       -m "Notebooks processed: ${NOTEBOOK_COUNT}" \
                       -m "Workflow: ${{ github.workflow }}" \
                       -m "Run: ${{ github.run_number }}"
            
            git push origin ${{ github.event.pull_request.head.ref }}
          fi
      
      - name: Comment on PR
        if: steps.changed-notebooks.outputs.changed == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const notebooks = fs.readFileSync('changed_notebooks.txt', 'utf8').trim().split('\n').filter(Boolean);
            
            if (notebooks.length === 0) return;
            
            const notebookList = notebooks.map(nb => {
              const name = nb.split('/').pop().replace('.ipynb', '');
              const wikiName = name.replace(/_/g, '-');
              return `- \`${nb}\`\n  - ğŸ“– [Wiki Page](../../wiki/${wikiName})\n  - ğŸ–¼ï¸ [Preview](../../blob/${{ github.event.pull_request.head.ref }}/previews/html/${name}.html)`;
            }).join('\n');
            
            const comment = `## ğŸ“š Documentation Auto-Generated\n\nI've automatically generated documentation for the notebooks in this PR:\n\n${notebookList}\n\n### What was created:\n- âœ… Wiki pages with comprehensive documentation\n- âœ… HTML previews showing rendered outputs\n- âœ… Preview thumbnails for gallery display\n\nThe documentation has been committed to this PR branch and will be included when merged.\n\n---\n*Generated by [Auto-Documentation Workflow](../../actions/runs/${{ github.run_id }})*`;
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
